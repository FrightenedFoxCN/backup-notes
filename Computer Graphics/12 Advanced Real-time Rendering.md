## Shadow Mapping

阴影表现了物体与物体之间、物体与光源之间的空间关系。为了画出阴影，我们需要考虑：

1. 如何判断某个点是否在阴影中？
2. 是否可以用某些已知的技术实现？

对于第一个问题，我们可以使用这个点与光源的连线上是否存在物体来判断；对于第二个问题，我们可以利用类似于深度判断的技术，借用一种被称为阴影缓冲区（shadow buffer）的数据结构来实现。

比较之前提到的 Z-buffer，它比较的可见性是与观察者相对的可见性；而 shadow buffer 考虑的可见性是与光源相对的可见性。如何去测试一个点是否在灯光的视角下可以被看见？我们只要判断，shadow buffer 中的深度值是否与这个点对应的三维点在 shadow buffer 中的深度值相同即可。

那么，如果我们有多个点光源或者有一个面光源呢？对于每个点光源，只需要进行线性组合；对于面光源，使用 [[11 Illumination]] 的方法，在面光源上做随机采样即可。

在深度检测中，我们需要注意几个问题。第一，由于采样的精度以及数值问题，我们在判断是否相同的时候可能会出现混乱。这种现象被称为 Z-fighting。因此，我们放弃无偏性而要求降噪，转而要求阴影连续，在 Z 值上加入一点点偏移量，这样可以得到一个理论上不正确但渲染效果较好的结果。

第二，因为光源角度和相机角度相差极大时，两种采样的方式会出现阴影失真的情形，用 [[10 Texture]] 中提到的重采样视角可以很容易地描述这个问题。因此，我们采用 Perspective Shadow Map (PSM) 的方法，使得渲染 shadow buffer 的时候的方向与视角方向完全相同，从而避免这种因为阴影缓冲区的分辨率过低导致的问题。

## Precomputed Radiance Transfer

考虑我们已经给出过多次的反射公式：
$$
L_r(o; p) = \int_{H^2} f_r(i, o; p)L_i(i; p)V(i; p)\langle n, i\rangle \mathrm di
$$
其中 $L_i(i; p)$ 为入射光，$V(i; p)$ 为可见性函数，$\langle n, i \rangle$ 为余弦衰减项。其中 $L_i(i;p)$ 可以加入其他物体来的光线，但是这里为了简单起见我们使用光源过来的光线。

为了计算这个积分，我们采用蒙特卡洛积分。我们需要考虑如何对这个积分过程进行加速。最快速的计算方式就是不去计算，也就是说，做出大量的预计算。为了完成这种预计算，我们给出一些强假设：

1. 无限远处的光源。这时入射光的 $L_i(i; p)$ 可以被简化为 $L_i(i)$ 项。我们使用 light probe 来描述。
2. 静态场景。这时 $V(i; p)$ 为完全确定的。
3. Lambertian 材质。这时 $f_r(i, o; p) = \frac{\rho_d}{\pi}$ ，原式子简化为：
$$
\frac{\rho_d}{\pi}\int_{H^2}L(i)V'(i)\mathrm di
$$
其中 $V'(i) = V(i; p)\langle n, i \rangle$.

根据卷积定理，我们可以对其进行傅里叶变换。当然，因为是在球面上，我们可以稍微改变一下我们的基函数，使用 SH basis 来解决这个问题。首先，我们计算 $L(i)$ 和 $V'(i)$ 的变换结果；然后，将它们撑起来。在这里我们会遇到在频域上的截断，需要妥善选择合适的阶数。

还可以使用其他的基。Haar 小波基对于高频的情形保留能力比 SH basis 更好，但它不够光滑；对于 Gaussian 函数的线性组合，虽然它们不一定是好的基函数，但是也可以将函数标识成一种线性组合，我们需要通过理想性最大化（expectation maximization, EM）的方法来求解，它的优势在于，它的积分式等操作往往是由闭的解析形式，在球面上的形式被称为 von Mises-Fisher (vMF) 分布；Zonal Harmonic 基函数可以很轻松地解决旋转的问题，因而可以较好地处理可形变几何体。

## Screen-Space Ambient Occlusion (SSAO)

这是一种后处理技术，可以近似计算软阴影，充分利用了标准的 Z-buffer。我们仍然从反射公式出发，我们将原来的积分近似为：
$$
L_r(o; p) = \int_{H^2} f_r(i, o; p)L_i(i; p)\mathrm di \int_{H^2}V(i; p)\langle n, i \rangle\mathrm di
$$
为了利用 Z-buffer，我们可以将其理解成一种对场景的逼近。利用这个逼近，我们可以做出一个对后半部分计算的近似计算。

考虑一个点 $P$ 对应的上半球面。在一些方向上取样，我们可以计算出当前位置的“地平线”，也就是说，在深度意义上可以看见的最大仰角。然后，将这些值连起来，我们就可以计算出在这个点附近的“可见范围”。利用这种“可见范围”，我们可以做到可见性的计算。

