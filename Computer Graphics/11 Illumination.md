## Rendering - Infinite dimensional integral

我们首先考虑，在计算机上如何做到数值积分？考虑
$$
\int_a^bf(x) \mathrm dx
$$
使用梯形法则（trapezoidal rule），将图像当成分段线性的函数，在多个点处进行采样然后求和的方式可以求出一个积分的近似解。我们认为，绘制就是一种无穷维的积分操作。考虑上一次（[[10 Texture]]）介绍的抗锯齿，我们是在二维的空间维度上做出的积分；考虑环境光，我们需要计算在所有可能方向上到达某个面上的光照的强度，也就是说，要在角度维度上积分；考虑动态模糊，我们需要在时间域上做积分，因为人眼和相机都有暂留效应或者曝光过程，这样一个重影的效果需要对时域积分得到；考虑真实相机，除了在时间域和空间域上积分，还需要在光瞳（lens pupil）上做积分。

但是高维积分是一个非常复杂的问题。我们会使用在正方形上随机投点来估算圆的面积，但是用这种方式计算更高维度的球的体积时，随着位数的增加，其采样在球内部的概率将趋近于 $0$ 。我们使用固定的格点去求积分，积分误差将表现为
$$
\frac{1}{N^{\frac 1 d}}
$$
其中 $N$ 为取样数，$d$ 为维数。随着位数的增大，误差将会无法有效下降，这是一个非常麻烦的问题。

直到今日，Monte-Carlo 方法是人类唯一已知的求任意维度任意积分的数值方法。通过摆脱格点随机取样的方法，我们的误差正比于
$$
\frac 1 {\sqrt N}
$$
其中 $N$ 为取样数。

Monte-Carlo 积分是一个在随机点上采样函数值来估计其积分的方法。其好处是其广泛的通用性，弱点是其只在平均意义上正确，且其收敛速度较慢。考虑开头提到的定积分，我们加入随机变量
$$
X_i \sim p(x)
$$
其中 $p(x)$ 为其 PDF，我们的 Monte Carlo 估计值就是
$$
F_N = \frac 1 N \sum_{i = 1}^N \frac{f(X_i)}{p(X_i)}
$$

考虑一个最简单的情形，如果我们在积分域上做随机采样，我们可以得到：
$$
p(x) = \frac 1 {b-a}, F_N = \frac{b - a}{N}\sum_{i = 1}^Nf(X_i)
$$

可以证明，这样得到的估计值是无偏（unbiased），也就是说，估计值的期望值就是我们想要的真实值。这样可以保证我们计算的时间越长，得到的误差是足够小的。
$$
\begin{align*}
E[F_N] &= E[\frac 1 N \sum_{i = 1}^N \frac{f(X_i)}{p(X_i)}]\\
&= \frac 1 N \sum_{i = 1}^N E[\frac{f(X_i)}{p(X_i)}]\\
&= \frac 1 N \sum_{i = 1}^N \int_a^b\frac{f(x)}{p(x)}p(x)\mathrm dx\\
&= \frac 1 N \sum_{i = 1}^N \int_a^bf(x)\mathrm dx\\
&= \int_a^b f(x)\mathrm dx
\end{align*}
$$
因此，我们保证样本数越多，得到的结果误差元就越小。

接下来，我们考虑怎么求解直接光照（direct lighting），其形式为：
$$
E(p) = \int L(p, \omega) \cos (\theta) \mathrm d\omega
$$
我们给出 PDF：
$$
X_i \sim \frac{1}{2\pi}, F_N = \frac{2\pi}{N} \sum_{i=1}^N L(p, \omega_i)\cos(\theta_i)
$$

但是，这样得到的结果有时候并不好，因为我们是在整个上半球面上均匀采样，面光源在这个球面上的投影是比较小的。因此，我们要想办法优化我们的 PDF，这种方式被称为重要性采样（importance sampling）。我们对被积函数在某个点上的取样概率是基于我们希望这个点对积分的“贡献”多少。因此，最理想的情形就是 $p(x)$ 为 $f(x)$ 归一化之后的情形，这时我们只需要一个样本就能估计出我们的目标值。因此，我们多次采样的过程就是为了减少 $p(x)$ 和 $f(x)$ 之间的误差。当我们知道关于 $f(x)$ 的信息越多，我们需要采样的次数就越少。

接下来我们考虑反射公式
$$
L_r(p, \omega_r) = \int_{H^2} f_r(p, \omega_i \rightarrow w_r)L_i(p, \omega_i)\cos(\theta) \mathrm d\omega_i
$$
然后，我们就可以采用 Monte-Carlo 方法来计算积分值。这时候我们有两种主要的采样方式，一种是对上半球面做均匀采样，一种是对光照做均匀采样。

## Global Illumination

全局光照需要对各个位置光线发生的反射进行记录。我们依然采用上面所述的反射公式，但是我们的入射光可能来自于光源，也有可能来自于被光源照亮的地方。这时我们会遇上一个递归：被光源照亮的地方的光照可能是由当前正在计算的地方的出射光带来，进而引起当前正在计算的地方的出射光的变化。在无限次采样之后，它会越来越趋近于真实值。

利用这种衰减的效应，我们使用 path tracing 的方法，也就是说，要对所有的光路进行求和。我们可以对光路进行分类：直接光路、反射一次得到的光路、反射两次得到的光路……利用这种方式，我们可以采用递归的方式来写出伪代码，每一轮计算用到了上一次光路的结果。

为了终止这种无限循环，我们有两种方式，一是设置一个递归深度上限，但这样得到的结果是有偏的；另一种方式是基于概率的终止（probabilistic termination），有一个非零的概率去采样任意深度的递归，这种方式被称为俄罗斯罗盘赌（Russian Roulette），设
$$
X_{rr} = \begin{cases}
\frac X {p_{rr}}\text{, with probability }p_{rr}\\
0\text{, otherwise}
\end{cases}
$$
于是我们得到：
$$
E[X_{rr}] = p_{rr}E[\frac X {p_{rr}}] + (1 - p_{rr})E[0] = E[X]
$$
它成功维持了得到的结果不变。注意，上面那个概率性的放大是为了“补偿”可能的彻底消除。它的问题在于，它增大了方差（variance），这是 biaseness 和 variance 之间的 tradeoff。在实际应用中，一般每个像素需要使用一百到一千个样本来完成。